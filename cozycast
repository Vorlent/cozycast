#!/bin/bash
source .env

function coturn_add_kurento_user {
    sudo -E docker exec -it cozycast_coturn_1 \
        turnadmin -a -u kurento -p $KURENTO_PASSWORD -r kurento.org
}

function liquibase_update {
    sudo docker run --rm -it \
        -v $(readlink -f ../liquibase/changelog.xml):/changelog.xml \
        -v $(readlink -f ../liquibase/driver):/liquibase/jdbc \
        --network host \
        liquibase/liquibase \
        --driver=org.postgresql.Driver \
        --classpath=/liquibase/jdbc/postgresql-42.2.9.jre7.jar \
        --url="jdbc:postgresql://$COZYCAST_DB_HOST:5432/cozycast" \
        --changeLogFile=/changelog.xml \
        --username=cozycast \
        --password=$COZYCAST_DB_PASS \
        update
}

case $1 in
    start)
        mkdir -p cozycast-server/cache/avatar
        cd docker-compose
        sudo -E docker-compose -p cozycast -f docker-compose.yml up -d
        coturn_add_kurento_user
        liquibase_update
        exit;
        ;;
    stop)
        cd docker-compose
        sudo -E docker-compose -p cozycast -f docker-compose.yml down
        exit;
        ;;
    build)
        cd docker-compose
        sudo -E docker-compose -p cozycast -f docker-compose.yml build
        exit;
        ;;
    dev)
        mkdir -p cozycast-server/cache/avatar
        cd docker-compose
        export SOURCE_URL=$(git remote get-url origin)
        sudo -E docker-compose -p cozycast -f docker-compose.yml -f docker-compose.dev.yml up -d
        coturn_add_kurento_user
        liquibase_update
        exit;
        ;;
    db)
        sudo docker exec -it cozycast_postgres_1 psql -U cozycast
        exit;
        ;;
    gvisor)
        (
          set -e
          URL=https://storage.googleapis.com/gvisor/releases/master/latest
          wget ${URL}/runsc
          wget ${URL}/runsc.sha512
          sha512sum -c runsc.sha512
          rm -f runsc.sha512
          sudo mv runsc /usr/local/bin
          sudo chown root:root /usr/local/bin/runsc
          sudo chmod 0755 /usr/local/bin/runsc
          sudo cp docker-compose/gvisor.json /etc/docker/daemon.json
          sudo chmod 644 /etc/docker/daemon.json
          sudo chown root:root /etc/docker/daemon.json
        )
        ;;
    *)
        printf "Usage: %s: <start|stop|builds>\n" $0
        exit 2
        ;;
esac
